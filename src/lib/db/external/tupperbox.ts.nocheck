/* eslint-disable @typescript-eslint/no-explicit-any */

import { appConfig, securityConfig } from "../../config";
import { Member, Tag, System } from "../entities";
import { getTables } from "../tables";
//import { fetch } from "@tauri-apps/plugin-http";

function tag(tuExport: any){
	const tagMapping = new Map<number, Tag>();
	const tags: Tag[] = [];
	for (const tuGroup of tuExport.groups) {
		const tag: Tag = {
			name: tuGroup.name,
			description: tuGroup.description || undefined,
			type: 0,
			viewInLists: false,
			id: window.crypto.randomUUID()
		};
		tags.push(tag);
		tagMapping.set(tuGroup.id, tag);
	}

	return {
		tags,
		tagMapping
	};
}

// eslint-disable-next-line @typescript-eslint/require-await
async function member(tuExport: any, systemInfo: System, tagMapping: Map<number, Tag>){
	const members: Member[] = [];
	const memberTags: MemberTag[] = [];

	for (const tuMember of tuExport.tuppers) {
		const member: Member = {
			name: tuMember.name,
			system: systemInfo,
			description: tuMember.description || undefined,
			pronouns: tuMember.pronouns || undefined,
			isArchived: false,
			isCustomFront: false,
			isPinned: false,
			dateCreated: new Date(tuMember.created_at),
			id: window.crypto.randomUUID()
		};
		if (tuMember.avatar_url && securityConfig.allowRemoteContent) {
			try {
				// TODO: SQLFile
				//const request = await fetch(tuMember.avatar_url);
				//member.image = new File([await request.blob()], (tuMember.avatar_url as string).split("/").pop()!);
			} catch (_e) {
				// whatever, again
			}
		}
		// This is assumed as we cannot subscribe to TupperBox Premium to figure out the exact format
		if (tuMember.banner && securityConfig.allowRemoteContent) {
			try {
				// TODO: SQLFile
				//const request = await fetch(tuMember.banner);
				//member.cover = new File([await request.blob()], (tuMember.banner as string).split("/").pop()!);
			} catch (_e) {
				// whatever, again
			}
		}
		members.push(member);

		if(tuMember.group_id){
			memberTags.push({
				member,
				tag: tagMapping.get(tuMember.group_id)!,
				id: window.crypto.randomUUID()
			});
		}
	}

	return { members, memberTags };
}

export async function importTupperBox(tuExport: any){
	const { tags, tagMapping } = tag(tuExport);
	const systemInfo = {
		name: "",
		description: "",
		id: window.crypto.randomUUID()
	} as System;
	const { members, memberTags } = await member(tuExport, systemInfo, tagMapping);

	try {
		// WIPE AMPERSAND
		await Promise.all(Object.values(getTables()).map(x => x.clear()));

		// ADD TO DATABASE
		const tables = getTables();
		await tables.systems.bulkAdd([systemInfo]);
		appConfig.defaultSystem = systemInfo.uuid;
		await tables.tags.bulkAdd(tags);
		await tables.members.bulkAdd(members);
		await tables.memberTags.bulkAdd(memberTags);
	}catch(e){
		console.error(e);
		return false;
	}

	return true;
}
